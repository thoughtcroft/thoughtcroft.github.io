<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="apple-touch-icon" sizes="180x180" href="/resources/apple-touch-icon.png">
<link rel="icon" type="image/png" href="/resources/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/resources/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/resources/manifest.json">
<link rel="mask-icon" href="/resources/safari-pinned-tab.svg" color="#5bbad5">
<meta name="theme-color" content="#ffffff">


  <title>Whipping up awesome with Chef</title>
  <meta name="description" content="This is part 3 of my Cloud programming series where I explore Chef,a very cool infrastructure automation tool.">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://wazza-is-awesome.com/devops/whipping-up-awesome-with-chef.html">
  <link rel="alternate" type="application/rss+xml" title="wazza is awesome" href="http://wazza-is-awesome.com/feed.xml">
  
    <!-- Add Google Analytics. -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-81713354-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics. -->

  
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">wazza is awesome</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
          <a class="page-link" href="/archive/">Archive</a>
          
        
          
          <a class="page-link" href="/categories/">Categories</a>
          
        
          
        
          
        
          
        
          
          <a class="page-link" href="/tag/">Tags</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Whipping up awesome with Chef</h1>
    <p class="post-meta"><time datetime="2013-03-22T00:00:00+11:00" itemprop="datePublished">Mar 22, 2013</time>
    
     • <a href="/tag/automation.html" rel="tag">automation</a>, <a href="/tag/chef.html" rel="tag">chef</a>, <a href="/tag/cloud.html" rel="tag">cloud</a>, <a href="/tag/devops.html" rel="tag">devops</a>, <a href="/tag/infrastructure.html" rel="tag">infrastructure</a>, <a href="/tag/ninefold.html" rel="tag">ninefold</a></p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>This is part 3 of my <strong>Cloud programming</strong> series where I explore Chef,
a very cool infrastructure automation tool.</p>

<p>When I started this blog series, I had a project in mind which required
me to learn Ruby and how to use the Fog cloud abstraction library so
that I could start and stop groups of Ninefold virtual servers at will.
That project is still on the drawing board :), for now I have moved on to
something far more important to our customers.</p>

<p>On my rubyist reinvention journey, I kept coming across something called
Chef, an open source configuration management tool managed by OpsCode
out of Seattle.  And as I listened to people’s enthusiasm about the
power of Chef, I realised that this was the answer to two of our biggest
challenges:</p>

<ul>
  <li>managing Ninefold’s expanding infrastructure without expanding our ops
team at the same rate;</li>
  <li>providing simple to use app deployment for our customers that also
allows them to leverage the full power of our production grade
multi-zone infrastructure.</li>
</ul>

<p>Here’s the quick explanation of Chef: <strong>your infrastructure as code</strong>.</p>

<p>OK, a bit cryptic, so try this longer definition:</p>

<ol>
  <li>
    <p>Chef is a systems integration framework, designed to bring configuration
management to your entire infrastructure. It is an open source project
with a vibrant community contributing to the base software and sharing
cookbooks (abstracted definitions of resource configuration).</p>
  </li>
  <li>
    <p>Servers are known as <strong>Nodes</strong>. Nodes have attributes that describe the
current or desired state of its configuration and provide one of several
mechanisms for communicating config changes.</p>
  </li>
  <li>
    <p><strong>Cookbooks</strong> are collections of files which configure the nodes to a
desired end-state. <strong>Recipes</strong> are written using ruby and a recipe DSL which
is readily extensible.</p>
  </li>
  <li>
    <p>The various elements of the configuration are known as <strong>resources</strong> e.g.
apache web server, iptables firewall, mysql database etc.  Recipes are (should be)
<a href="https://en.wikipedia.org/wiki/Idempotence#Computer_science_meaning">idempotent</a>
i.e. re-running the recipe on a node multiple times always returns the system to
an identical state.</p>
  </li>
</ol>

<p>In terms of software, chef-client runs on the node and talks to a server
which holds the cookbooks and attribute status of all registered nodes.
There is a special chef-solo version of the server which runs on the
node, an open source chef-server, an OpsCode Hosted Chef server as a
service and a licensed, multi-tenant, HA edition called Private Chef.</p>

<p>A chef-client run operates in two stages. During compilation, the
various code files – libraries, attributes, definitions, recipes etc –
are loaded and evaluated. A resource list is built from the DSL in each
recipe in the order they appear. During convergence, each resource is
configured according to the relevant DSL configuration.
Rather than go into a lot more detail about Chef – and believe me, there
is a lot of detail to get your head around – I am going to share my Top
Four Tips for Chef.</p>

<h3 id="tip-1---understand-the-difference-in-compilation-vs-convergence">Tip 1 - Understand the difference in Compilation vs Convergence</h3>

<p>During compilation, any normal Ruby code is evaluated when the relevant
file – attribute, library, recipe etc – is first loaded.  If you want to
calculate some value after a resource has been converged and then save
it in an attribute, you will need to delay the evaluation by wrapping
the relevant code in a ruby_block resource:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ruby_block</span> <span class="err">“</span><span class="n">save</span> <span class="n">node</span> <span class="n">state</span><span class="err">”</span> <span class="k">do</span>
  <span class="n">block</span> <span class="k">do</span>
    <span class="n">node</span><span class="p">.</span><span class="nf">set</span><span class="p">[</span><span class="s1">'some_host'</span><span class="p">][</span><span class="s1">'configured_time'</span><span class="p">]</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">to_s</span>
    <span class="n">node</span><span class="p">.</span><span class="nf">save</span>
  <span class="k">end</span>
  <span class="n">action</span> <span class="ss">:create</span>
<span class="k">end</span>
</code></pre></div></div>

<p>For a more detailed and highly readable explanation, check out the
<a href="https://docs.chef.io/chef_client.html">Anatomy of a Chef Run</a>.</p>

<h3 id="tip-2----the-cause-of-chef-run-terminating-with-undefined-method--for-nilnilclass">Tip 2 -  The cause of chef run terminating with “undefined method ‘[]’ for nil:NilClass”</h3>

<p>This initially perplexing message is almost always due to trying to
reference a node attribute that doesn’t exist. For example if I am
expecting to use <code class="language-plaintext highlighter-rouge">node['my_cookbook']['app']['version']</code> somewhere in my
recipe, I will get the value ‘nil’ if <code class="language-plaintext highlighter-rouge">node['my_cookbook']['app']</code> exists
but there is no <code class="language-plaintext highlighter-rouge">['version']</code> attribute.  But if
<code class="language-plaintext highlighter-rouge">node['my_cookbook']['app']</code> also doesn’t exist then I get the dreaded
undefined method ‘[]’ since I am in effect trying to reference
<code class="language-plaintext highlighter-rouge">nil['version']</code> and nil doesn’t have a ‘[]’ method.</p>

<p>To avoid this common occurrence in your early recipe writing, ensure
attributes exist before you use them.  Two methods are:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="nf">attribute?</span><span class="p">(</span><span class="s1">'version'</span><span class="p">)</span>
  <span class="c1"># there is some attribute somewhere called 'version'</span>
  <span class="c1"># perhaps not the best method</span>
<span class="k">end</span>

<span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s1">'my_cookbook'</span><span class="p">][</span><span class="s1">'app'</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="p">[</span><span class="s1">'my_cookbook'</span><span class="p">][</span><span class="s1">'app'</span><span class="p">][</span><span class="s1">'version'</span><span class="p">]</span>
  <span class="c1"># there is an 'app' and a 'version' for 'app'</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="tip-3----essential-knife-plug-in-knife-block">Tip 3 -  Essential knife plug-in: knife-block</h3>

<p>Knife is the command line tool for managing your chef server and nodes
from your workstation. If you use Chef Server it is likely that you will
have more than one of these.  At Ninefold, we use Private Chef and as
well as multiple instances of the server, we also have multiple
organisations within each server – you can think of each organisation as
a logical Chef Server with separate cookbooks etc but sharing the one
client-validation key.</p>

<p>Managing multiple knife.rb configuration files is a bit of a nightmare,
and requires you to place the relevant knife.rb, chef-validator.pem and
client.pem files into each project. But then if you want to push a
cookbook that you are working on from your development chef to your
testing chef, there is a spot of juggling required. That is until you
install the
<a href="https://github.com/knife-block/knife-block">knife-block plugin</a>
by Green and Secure IT Limited.</p>

<p>Place all your knife.rb and .pem files into your /home/.chef/ directory
and rename each knife.rb file as knife-{something}.rb e.g. knife-dev.rb,
knife-test.rb, knife-wazza-is-awesome.rb. <code class="language-plaintext highlighter-rouge">knife block dev</code> will create
a knife.rb symlink to the knife-dev.rb.</p>

<p>knife walks up the directory structure looking in ../.chef/ to find the
knife.rb configuration so placing all those files in /home/.chef/ means
knife will always find the configuration required for your current chef
context.  At any time you can find out your choices by</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>knife block list
  The available chef servers are:
    <span class="k">*</span> dev
    <span class="k">*</span> <span class="nb">test</span>
    <span class="k">*</span> wazza-is-awesome <span class="o">[</span> Currently Selected <span class="o">]</span>
</code></pre></div></div>

<p>And switch context simply using</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>knife block <span class="nb">test
  </span>The knife configuration has been updated to use <span class="nb">test</span>

<span class="nv">$ </span>knife block list
  The available chef servers are:
    <span class="k">*</span> dev
    <span class="k">*</span> <span class="nb">test</span> <span class="o">[</span> Currently Selected <span class="o">]</span>
    <span class="k">*</span> wazza-is-awesome
</code></pre></div></div>

<h3 id="tip-4----manage-cookbook-dependencies-using-berkshelf">Tip 4 -  Manage cookbook dependencies using Berkshelf</h3>

<p>As <a href="http://berkshelf.com">Berkshelf</a> states “If you’re familiar with Bundler, then
Berkshelf is a breeze”.</p>

<p>A cookbook’s metadata.rb file uses ‘depends’ clauses to specify cookbook
dependencies – at Ninefold, we almost always specify exact versions to
isolate us from potential breaking changes. Chef ensures that these
versions are loaded onto the node at the start of a run provided they
are present on the Chef Server. How do they get on to the server in the
first place? You upload them using knife.  But if you have a number of
cookbook development projects and if you are reliant on specific branch
versions of community cookbooks, then managing this process is very
difficult. Until Berkshelf.</p>

<p>And ermagherd, Berkshelf ers ersum!</p>

<p>Cookbooks can be easily managed in single repositories. Dependency data
can be drawn from the cookbook’s metadata.rb and the source of dependent
cookbooks can be defined in various ways. Cookbooks are installed into
/home/.berkshelf and this is where they are sourced by default but if
missing from there they can be sourced from the Opscode Community
Cookbooks site, a specific branch of a git repository, a path on the
workstation or from a chef server.  Once the cookbooks have been
installed or updated they can be bulk uploaded into the Chef Server.</p>

<p>Ninefold’s cookbook development and customer provisioning process makes
extensive use of Berkshelf and I highly recommend reading an
introduction to authoring cookbooks by Jamie Winsor, the creator of
Berkshelf.</p>

<p><em>Originally published at Ninefold (2010-2015), a cloud
services provider I helped found.</em></p>


  </div>

</article>


<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span>Jul 26, 2013</span> &raquo; <a href="/devops/how-to-write-and-install-an-ohai-plugin.html">How to write and install an Ohai plugin, the Fight Club way</a></li>
    
      <li><span>Oct 8, 2012</span> &raquo; <a href="/cloud/how-i-learned-to-stop-worrying-and-love-the-cloud.html">How I learned to stop worrying and love the cloud</a></li>
    
      <li><span>Aug 4, 2016</span> &raquo; <a href="/devops/taking-control-of-your-ssh-config.html">Simplify server access by using an SSH config file</a></li>
    
      <li><span>Apr 16, 2012</span> &raquo; <a href="/cloud/a-social-cloud-experiment.html">A social cloud programming experiment</a></li>
    
  </ul>
</div>



  

  <!-- Add Disqus comments. -->
  <div id="disqus_thread"></div>
  <script type="text/javascript">
var disqus_config = function () {
  this.page.url = 'http://wazza-is-awesome.com/devops/whipping-up-awesome-with-chef.html';
  this.page.identifier = '/devops/whipping-up-awesome-with-chef';
};
(function() {
  var d = document, s = d.createElement('script');
  s.src = '//wazza-is-awesome.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
})();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <!-- End Disqus comments. -->





      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">wazza is awesome</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>wazza is awesome</li>
          <li><a href="mailto:warren /at/ bainsworld.com">warren /at/ bainsworld.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/thoughtcroft"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">thoughtcroft</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/thoughtcroft"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">thoughtcroft</span></a>

          </li>
          

          
          <li>
            <a href="https://au.linkedin.com/in/warrenbain"><span class="icon icon--linkedin"><svg viewBox="0 0 16 16"><path fill="#6F80BC" d="M4.724,14H2.152V6.26h2.572V14z M3.438,5.204H3.422C2.559,5.204,2,4.609,2,3.867 c0-0.759,0.575-1.337,1.456-1.337c0.879,0,1.421,0.579,1.438,1.337C4.894,4.609,4.335,5.204,3.438,5.204z M14,14h-2.572V9.859 c0-1.04-0.37-1.75-1.302-1.75c-0.712,0-1.135,0.478-1.321,0.94C8.738,9.215,8.721,9.447,8.721,9.678V14H6.148 c0,0,0.034-7.014,0-7.74h2.573v1.097c0.342-0.527,0.953-1.278,2.316-1.278C12.73,6.079,14,7.185,14,9.562V14z"/></svg>
</span><span class="username">warrenbain</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>A vainglorious attempt to prove Wazza's general awesomeness. Then again, people have actually rated him for that on LinkedIn.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
